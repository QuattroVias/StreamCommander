const { app, BrowserWindow, screen, ipcMain } = require('electron');
const fs = require('fs');
const path = require('path');

let win = null;
let currentConfig = null;

function findConfigPath() {
  const firstPath = path.join(__dirname, '..', '..', 'config.json');
  if (fs.existsSync(firstPath)) {
    return firstPath;
  }
  const secondPath = path.join(__dirname, '..', '..', '..', 'config.json');
  if (fs.existsSync(secondPath)) {
    return secondPath;
  }
  return firstPath;
}
const configPath = findConfigPath();

// ðŸ“„ Ð§Ñ‚ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
function readConfig() {
  try {
    const raw = fs.readFileSync(configPath, 'utf8');
    return JSON.parse(raw);
  } catch (err) {
    console.error('[CONFIG] ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ config.json:', err);
    return {
      window1_width: 900,
      window1_height: 500
    };
  }
}

// ðŸ“¦ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ðº ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾Ð¼Ñƒ Ð¾ÐºÐ½Ñƒ
function applyConfig(config) {
  if (!win) return;
  currentConfig = readConfig();

  const screenSize = screen.getPrimaryDisplay().workAreaSize;
  const width = config.window1_width || 900;
  const height = config.window1_height || 500;
  const x = Math.round((screenSize.width - width) / 2);
  const y = 0;

  const zoom = (config.chat_zoomov || 10) / 10;

  win.setBounds({ x, y, width, height });
  win.webContents.setZoomFactor(zoom);

  if (config.chat_ovd) {
    win.loadURL(config.chat_ovd);
    console.log('[CONFIG] Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ URL Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸:', config.chat_ovd);
  }

  console.log('[CONFIG] ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¾ÐºÐ½Ð°:', { x, y, width, height, zoom });
}

function createWindow() {
  currentConfig = readConfig();

  const screenSize = screen.getPrimaryDisplay().workAreaSize;
  const width = currentConfig.window1_width || 900;
  const height = currentConfig.window1_height || 500;
  const x = Math.round((screenSize.width - width) / 2);
  const y = 0;

  const zoom = (currentConfig.chat_zoomov || 10) / 10;

  win = new BrowserWindow({
    width,
    height,
    x,
    y,
    transparent: true,
    frame: false,
    alwaysOnTop: true,
    resizable: false,
    focusable: false,
    skipTaskbar: true,
    hasShadow: false,
    webPreferences: {
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js'),
      devTools: false
    }
  });

  win.setHasShadow(false);
  win.setIgnoreMouseEvents(true);

  const urlToLoad = currentConfig.chat_ovd || 'http://localhost:8888';
  win.loadURL(urlToLoad);

  win.webContents.on('did-finish-load', () => {
    win.webContents.setZoomFactor(zoom);
  });

  watchConfigFile();
}


// ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº
app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') app.quit();
});
