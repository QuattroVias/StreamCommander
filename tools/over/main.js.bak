const { app, BrowserWindow, screen } = require('electron');
const fs = require('fs');
const path = require('path');

let win = null;
let currentConfig = null;

const configPath = path.join(__dirname, '..', '..', 'config.json');

// ðŸ“„ Ð§Ñ‚ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
function readConfig() {
  try {
    const raw = fs.readFileSync(configPath, 'utf8');
    return JSON.parse(raw);
  } catch (err) {
    console.error('[CONFIG] ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‡Ñ‚ÐµÐ½Ð¸Ñ config.json:', err);
    return {
      chat_widthx: 0,
      chat_widthy: 0,
      chat_widthov: 50,
      chat_heightov: 240,
      chat_zoomov: 10
    };
  }
}

// ðŸ“¦ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ðº Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾Ð¼Ñƒ Ð¾ÐºÐ½Ñƒ
function applyConfig(config) {
  if (!win) return;

  const cursorPoint = screen.getCursorScreenPoint();
  const display = screen.getDisplayNearestPoint(cursorPoint);

  const widthx = config.chat_widthx || 0;
  const widthy = config.chat_widthy || 0;
  const width = config.chat_widthov || 50;
  const height = config.chat_heightov || 240;
  const zoom = (config.chat_zoomov || 10) / 10;

  const x = widthx;
  const y = widthy;

  win.setBounds({ x, y, widthx, widthy, width, widthx, height });
  win.webContents.setZoomFactor(zoom);

  console.log('[CONFIG] ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:', { x, y, widthx, widthy, width, height, zoom });
}

// ðŸ‘ï¸ Ð¡Ð»ÐµÐ¶ÐµÐ½Ð¸Ðµ Ð·Ð° config.json
function watchConfigFile() {
  fs.watchFile(configPath, { interval: 500 }, (curr, prev) => {
    if (curr.mtime !== prev.mtime) {
      try {
        const newConfig = readConfig();
        currentConfig = newConfig;
        applyConfig(currentConfig);
      } catch (err) {
        console.error('[CONFIG] ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸:', err);
      }
    }
  });
}

// ðŸªŸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾ÐºÐ½Ð°
function createWindow() {
  currentConfig = readConfig();

  const widthx = currentConfig.chat_widthx || 0;
  const widthy = currentConfig.chat_widthy || 0;
  const width = currentConfig.chat_widthov || 50;
  const height = currentConfig.chat_heightov || 240;
  const zoom = (currentConfig.chat_zoomov || 10) / 10;

  win = new BrowserWindow({
    widthx,
    widthy,
    width,
    height,
    transparent: true,
    frame: false,
    alwaysOnTop: true,
    resizable: false,
    focusable: false,
    skipTaskbar: true,
    hasShadow: false,
    webPreferences: {
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js'),
      devTools: false
    }
  });

  win.setHasShadow(false);
  win.setIgnoreMouseEvents(true);

  // ðŸ”„ ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÐºÑÑˆÐ°
  const timestamp = Date.now();
  win.webContents.session.clearCache().then(() => {
    return win.webContents.session.clearStorageData({
      storages: ['appcache', 'serviceworkers', 'caches']
    });
  }).then(() => {
    win.webContents.session.webRequest.onBeforeSendHeaders((details, callback) => {
      details.requestHeaders['Cache-Control'] = 'no-cache';
      details.requestHeaders['Pragma'] = 'no-cache';
      callback({ cancel: false, requestHeaders: details.requestHeaders });
    });

    win.loadURL(`http://localhost:8888/?v=${timestamp}`, {
      extraHeaders: 'pragma: no-cache\ncache-control: no-cache\n'
    });
  });

  win.webContents.on('did-finish-load', () => {
    win.webContents.setZoomFactor(zoom);
  });

  applyConfig(currentConfig);
  watchConfigFile();
}

// ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº
app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') app.quit();
});
