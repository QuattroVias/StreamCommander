window.addEventListener('load', async () => {
  console.log("–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã");

  const isMainWindow = document.getElementById('volumeSlider') !== null;
  const isQueueWindow = document.getElementById('queueList') !== null;

  if (window.pywebview) {
    if (isMainWindow) {
      // === MAIN WINDOW ===
      try {
        // –ü–æ–ª—É—á–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å
        const volume = await pywebview.api.get_volume();
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å:', volume);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ volume - —á–∏—Å–ª–æ
        if (typeof volume === 'number') {
          updateVolume(volume);  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        } else {
          console.error("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏:", volume);
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏:", err);
      }

      // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      const maxVideoLength = await pywebview.api.get_max_video_length();
      document.getElementById('maxVideoLength').value = maxVideoLength;

      const keywords = await pywebview.api.get_keywords();
      updateKeywordList(keywords);

      const logs = await pywebview.api.get_logs();
      logs.forEach(l => appendLog(l));
    }

    if (isQueueWindow) {
      // === QUEUE WINDOW ===
      const queue = await pywebview.api.get_queue();
      updateQueue(queue);
    }
  }

  // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ —Ç–æ–ª—å–∫–æ –≤ –æ–∫–Ω–µ –æ—á–µ—Ä–µ–¥–∏
  if (isQueueWindow) {
    setInterval(async () => {
      if (window.pywebview) {
        const queue = await pywebview.api.get_queue();
        updateQueue(queue);
      }
    }, 4000);
  }
});

function updateChatWidthY(value) {
  console.log("[JS] updateChatWidthY:", value);
  const input = document.getElementById('chatWidthY'); // ‚úÖ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å HTML
  if (input) input.value = value;
}
function updateChatWidthX(value) {
  console.log("[JS] updateChatWidthX:", value);
  const input = document.getElementById('chatWidthX'); // ‚úÖ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å HTML
  if (input) input.value = value;
}
function updateChatWidthOv(value) {
  console.log("[JS] updateChatWidthOv:", value);
  const input = document.getElementById('chatWidthOv'); // ‚úÖ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å HTML
  if (input) input.value = value;
}
function updateChatHeightOv(value) {
  console.log("[JS] updateChatHeightOv:", value);
  const input = document.getElementById('chatHeightOv');
  if (input) input.value = value;
}
function updateChatZoomOv(value) {
  console.log("[JS] updateChatZoomOv:", value);
  const input = document.getElementById('chatZoomOv');
  if (input) input.value = value;
}


  function updateChatWidth(value) {
    console.log("[JS] updateChatWidth:", value);
    const input = document.getElementById('chatWidth');
    if (input) input.value = value;
  }
  function updateChatHeight(value) {
    console.log("[JS] updateChatHeight:", value);
    const input = document.getElementById('chatHeight');
    if (input) input.value = value;
  }
  function updateChatTimeout(value) {
    console.log("[JS] updateChatTimeout:", value);
    const input = document.getElementById('chatTimeout');
    if (input) input.value = value;
  }
  function updateChatLimit(value) {
    console.log("[JS] updateChatLimit:", value);
    const input = document.getElementById('chatMaxMessages');
    if (input) input.value = value;
  }


// === –ì—Ä–æ–º–∫–æ—Å—Ç—å ===
function updateVolume(volume) {
    const slider = document.getElementById('volumeSlider');
    const label = document.getElementById('volumeLabel');

    console.log("[DEBUG] updateVolume –≤—ã–∑–≤–∞–Ω —Å:", volume);

    slider.value = volume;
    label.innerText = volume;
}

function onVolumeSliderChange(val) {
  console.log("[DEBUG] –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ø–æ–ª–∑—É–Ω–æ–∫:", val);  // –û—Ç–ª–∞–¥–∫–∞
  updateVolume(val);
  if (window.pywebview) {
    pywebview.api.set_volume(val);
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∏–∫–∞ –Ω–∞ –ø–æ–ª–∑—É–Ω–æ–∫
document.getElementById('volumeSlider').addEventListener('input', (e) => {
  const value = e.target.value;
  onVolumeSliderChange(value);  // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é
});


// === –ì—Ä–æ–º–∫–æ—Å—Ç—å VLC ===
function updateVlcVolume(volume) {
    const slider = document.getElementById('vlcVolumeSlider');
    const label = document.getElementById('vlcVolumeLabel');

    console.log("[DEBUG] updateVlcVolume –≤—ã–∑–≤–∞–Ω —Å:", volume);

    slider.value = volume;
    label.innerText = volume;
}

function onVlcVolumeSliderChange(val) {
    console.log("[DEBUG] –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ VLC —á–µ—Ä–µ–∑ –ø–æ–ª–∑—É–Ω–æ–∫:", val);
    updateVlcVolume(val);
    if (window.pywebview) {
        pywebview.api.set_vlc_volume(val);  // –í—ã–∑–æ–≤ Python API
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ VLC
document.getElementById('vlcVolumeSlider').addEventListener('input', (e) => {
    const value = e.target.value;
    onVlcVolumeSliderChange(value);
});











// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
console.log('–§—É–Ω–∫—Ü–∏—è updateMaxVideoLength –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof updateMaxVideoLength);
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã –≤–∏–¥–µ–æ
function updateMaxVideoLength(minutes) {
  console.log("[DEBUG] updateMaxVideoLength –≤—ã–∑–≤–∞–Ω–∞ —Å:", minutes);
  const inputField = document.getElementById('maxVideoLength');
  if (inputField) {
    inputField.value = minutes; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
  } else {
    console.log("[DEBUG] –≠–ª–µ–º–µ–Ω—Ç input –Ω–µ –Ω–∞–π–¥–µ–Ω");
  }
}
// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –≤–∏–¥–µ–æ
function onMaxVideoLengthChange(value) {
    let minutes = parseInt(value);
    if (isNaN(minutes) || minutes <= 0) {
        minutes = 10; // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ñ–∏–≥–Ω—é –≤–≤–µ–¥—ë—Ç, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ 10
    }
    let seconds = minutes * 60;
    pywebview.api.set_max_video_length(seconds);
}




// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
console.log('–§—É–Ω–∫—Ü–∏—è updateMinViews –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof updateMinViews);
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
function updateMinViews(views) {
  console.log("[DEBUG] updateMinViews –≤—ã–∑–≤–∞–Ω–∞ —Å:", views);
  const inputField = document.getElementById('minViews');
  if (inputField) {
    inputField.value = views; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
  } else {
    console.log("[DEBUG] –≠–ª–µ–º–µ–Ω—Ç input minViews –Ω–µ –Ω–∞–π–¥–µ–Ω");
  }
}
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
function onMinViewsChange(value) {
  let views = parseInt(value);
  if (isNaN(views) || views <= 0) {
    views = 1000; // –¥–µ—Ñ–æ–ª—Ç –µ—Å–ª–∏ —Ñ–∏–≥–Ω—é –≤–≤–µ–ª–∏
  }
  pywebview.api.set_min_views(views);
}






// === –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ ===
async function addKeyword() {
  const input = document.getElementById('keywordInput');
  const word = input.value.trim();
  if (!word) return;
  const res = await pywebview.api.add_keyword(word);
  if (res.status === 'added') updateKeywordList(res.keywords);
  input.value = '';
}

function updateKeywordList(list) {
  const ul = document.getElementById('keywordsList');
  ul.innerHTML = '';
  list.forEach(word => {
    const li = document.createElement('li');
    li.textContent = word;
    ul.appendChild(li);
  });
}

// === –õ–æ–≥ ===
function appendLog(message) {
  const logArea = document.getElementById('log');
  logArea.value += message + '\n';
  logArea.scrollTop = logArea.scrollHeight;
}




// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
function getProgress(duration) {
  const elapsed = getElapsedTime(); // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ—à–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ WebSocket –∏–ª–∏ –¥—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö)
  return (elapsed / duration) * 100;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
function getElapsedTime() {
  // –≠—Ç–æ –ø—Ä–∏–º–µ—Ä, –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –≤—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è –∏–∑ –≤–∞—à–µ–≥–æ –ø–ª–µ–µ—Ä–∞ –∏–ª–∏ API.
  return 45; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)
}


function formatDuration(seconds) {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}



// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏-–æ—á–µ—Ä–µ–¥–∏ - –≤—ã–Ω–µ—Å–µ–Ω–∞ –Ω–∞—Ä—É–∂—É, —á—Ç–æ–±—ã –±—ã–ª–∞ –≤–∏–¥–Ω–∞ –≤—Å–µ–º
function updateQueueMini(queue) {
  const left = document.getElementById('queueMiniLeft');
  const right = document.getElementById('queueMiniRight');
  if (!left || !right) return;

  left.innerHTML = '';
  right.innerHTML = '';

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ 6 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–ø–æ 3 —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞)
  queue = queue.slice(0, 6);

  queue.forEach((item, idx) => {
    const li = document.createElement('li');
    li.style.marginLeft = '0';
    li.style.paddingLeft = '0';
    li.className = 'row';
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.gap = '2px';
    li.style.marginBottom = '2px';
    li.style.borderRadius = '8px';
    li.style.padding = '0px';
    li.style.position = 'relative';
    li.style.width = '100%';
    li.style.maxWidth = '100%';
    li.style.overflow = 'hidden';
    li.style.boxSizing = 'border-box';

    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.background = '#1a1a1a';
    wrapper.style.padding = '4px';
    wrapper.style.borderRadius = '8px';
    wrapper.style.flex = '1';
    wrapper.style.width = '100%';
    wrapper.style.maxWidth = '100%';
    wrapper.style.overflow = 'hidden';
    wrapper.style.boxSizing = 'border-box';

    let thumbSrc = item.thumbnail;
    if (thumbSrc && /^[a-zA-Z]:\\/.test(thumbSrc)) {
      thumbSrc = 'file:///' + thumbSrc.replace(/\\/g, '/');
    }

    const img = document.createElement('img');
    img.src = thumbSrc;
    img.alt = 'Thumbnail';
    img.style.height = '50px';
    img.style.width = '90px';
    img.style.objectFit = 'contain';
    img.style.borderRadius = '5px';
    img.style.flexShrink = '0';

    const rootStyles = getComputedStyle(document.documentElement);
    const highlightColor = rootStyles.getPropertyValue('--favorite-item-hover-color').trim();

    const info = document.createElement('div');
    info.style.marginLeft = '8px';
    info.style.overflow = 'hidden';
    info.style.textOverflow = 'ellipsis';
    info.style.whiteSpace = 'nowrap';
    info.style.flex = '1';
    info.style.minWidth = '0';
    info.innerHTML =
      `<div style="color: #f5f5f5; font-weight: bold; font-size: 13px;">${truncate(item.title, 22)}</div>
       <div style="color: #969696; font-size: 11px;">${formatDuration(item.duration) === '0:00' ? 'playlist' : formatDuration(item.duration)}</div>
       <div style="color: ${highlightColor}; font-size: 12px; font-weight: 700;">${truncate(item.customer, 28)}</div>`;

  if (item.customer !== "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ") {
    const plus = document.createElement('div');
    plus.className = 'plus-btn btn-primary';
    plus.textContent = '+';
    plus.style.position = 'absolute';
    plus.style.bottom = '4px';
    plus.style.right = '1px';
    plus.style.width = '24px';
    plus.style.height = '24px';
    plus.style.background = '#444';
    plus.style.color = 'white';
    plus.style.display = 'flex';
    plus.style.alignItems = 'center';
    plus.style.justifyContent = 'center';
    plus.style.fontSize = '16px';
    plus.style.fontWeight = 'bold';
    plus.style.cursor = 'pointer';
    plus.style.zIndex = '10';

    // –î–æ–±–∞–≤–∏–º –∫ plus –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞, –≤–Ω—É—Ç—Ä–∏ –æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å currentItemToAdd, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä—è–≤–∏–º –ø–æ–∑–∂–µ
    plus.addEventListener('click', async (e) => {
      e.stopPropagation();
	  currentItemToAdd = item;
	  await loadPlaylistsForModal();
	  addToPlaylistModal.style.display = 'block';
    });

		wrapper.appendChild(plus);
	  }

    wrapper.appendChild(img);
    wrapper.appendChild(info);
    li.appendChild(wrapper);

    if (idx % 2 === 0) {
      left.appendChild(li);
    } else {
      right.appendChild(li);
    }
  });

  if (queue.length > 0) {
    updateNowPlaying(queue[0]);
  }
}



// –¢–µ–∫—É—â–∏–π –¥–æ–±–∞–≤–ª—è–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
let currentItemToAdd = null;
let addToPlaylistModal = null;
let playlistSelectModal = null;
let btnConfirmAddToPlaylist = null;
let btnCancelAddToPlaylist = null;

async function loadPlaylistsForModal() {
  const playlists = await window.pywebview.api.get_playlists();
  playlistSelectModal.innerHTML = '';
  playlists.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    playlistSelectModal.appendChild(option);
  });
}
// --- DOMContentLoaded ---
document.addEventListener('DOMContentLoaded', () => {
  addToPlaylistModal = document.getElementById('addToPlaylistModal');
  playlistSelectModal = document.getElementById('playlistSelectModal');
  btnConfirmAddToPlaylist = document.getElementById('btnConfirmAddToPlaylist');
  btnCancelAddToPlaylist = document.getElementById('btnCancelAddToPlaylist');

  btnConfirmAddToPlaylist.onclick = async () => {
    console.log('Confirm clicked', currentItemToAdd); // –õ–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (!currentItemToAdd) {
      alert('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
      return;
    }
    const selectedPlaylist = playlistSelectModal.value;
    if (!selectedPlaylist) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç');
      return;
    }
    try {
      const res = await window.pywebview.api.add_favorite_to_playlist(currentItemToAdd.title, selectedPlaylist);
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –ø–ª–µ–π–ª–∏—Å—Ç');
      console.error(err);
    }
    addToPlaylistModal.style.display = 'none';
    currentItemToAdd = null;
  };

  btnCancelAddToPlaylist.onclick = () => {
    console.log('Cancel clicked');
    addToPlaylistModal.style.display = 'none';
    currentItemToAdd = null;
  };

  // –ó–¥–µ—Å—å –≤—ã–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
  (async () => {
    if (window.pywebview) {
      const queue = await window.pywebview.api.get_queue();
      updateQueueMini(queue);
    }
  })();

  setInterval(async () => {
    if (window.pywebview) {
      const queue = await window.pywebview.api.get_queue();
      updateQueueMini(queue);
    }
  }, 5000);
});



// –ü–æ–º–µ—Ç–∏—Ç—å –≤–∏–¥–µ–æ –∫–∞–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
function markAsFavorite(title) {
  console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Python:', title);  // <-- –î–û–ë–ê–í–¨ –≠–¢–û
  if (window.pywebview) {
    window.pywebview.api.mark_favorite(title)
      .then(res => {
        console.log("üì• –û—Ç–≤–µ—Ç –æ—Ç Python:", res);  // <-- –î–û–ë–ê–í–¨ –≠–¢–û
        if (res.success) {
          console.log("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:", res.filename);
        } else {
          console.warn("‚ùå –û—à–∏–±–∫–∞:", res.error);
        }
      })
      .catch(err => console.error("‚ùó –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ API:", err));  // <-- –î–û–ë–ê–í–¨ –≠–¢–û
  } else {
    console.warn("‚ö†Ô∏è pywebview –Ω–µ –Ω–∞–π–¥–µ–Ω!");
  }
}



function renderFavoritesList(favorites) {
  const container = document.getElementById("favoritesList");
  container.innerHTML = "";

  const grouped = {};

  favorites.forEach(fav => {
    const match = fav.filepath.match(/cache[\\/](.*?)[\\/]/);
    const groupName = match ? match[1] : "–ë–µ–∑ –ø–ª–µ–π–ª–∏—Å—Ç–∞";

    // üéØ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–ª–µ–π–ª–∏—Å—Ç—É (–µ—Å–ª–∏ –æ–Ω –≤—ã–±—Ä–∞–Ω)
    if (currentPlaylist && groupName !== currentPlaylist) return;

    if (!grouped[groupName]) grouped[groupName] = [];
    grouped[groupName].push(fav);
  });

  if (Object.keys(grouped).length === 0) {
    container.innerHTML = "<i style='color: #777; padding: 4px'>–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ</i>";
    return;
  }

  for (const [groupName, groupItems] of Object.entries(grouped)) {
	const groupHeader = document.createElement("div");
	groupHeader.textContent = `‚Äî  ${groupName}  ‚Äî`;
	groupHeader.style.margin = "2px 2px 2px";
	groupHeader.style.fontWeight = "bold";
	groupHeader.style.color = "#ccc";
	groupHeader.style.fontSize = "13px";
	groupHeader.style.textAlign = "center";
	container.appendChild(groupHeader);

    groupItems.forEach(fav => {
      const div = document.createElement("div");
      div.className = "favorite-item";
      div.style.display = "flex";
      div.style.justifyContent = "space-between";
      div.style.alignItems = "center";
      div.style.padding = "1px 8px";
      div.style.transition = "box-shadow 0.0s, background-color 0.0s";
      div.style.borderRadius = "6px";

      let isHovered = false;
      let isOverRemoveBtn = false;

      const titleSpan = document.createElement("span");
      titleSpan.textContent = `+ ${fav.title}`;
      titleSpan.style.cursor = "pointer";
      titleSpan.style.width = "100%";
      titleSpan.addEventListener("click", async () => {
        console.log("‚ñ∂Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –æ—á–µ—Ä–µ–¥—å:", fav.filename);
        await window.pywebview.api.add_favorite_by_filename(fav.filename);
      });

      const removeBtn = document.createElement("button");
      removeBtn.textContent = "-";
      removeBtn.style.background = "rgb(255 68 68 / 60%)";
      removeBtn.style.border = "none";
      removeBtn.style.color = "#fff";
      removeBtn.style.padding = "2px 8px";
      removeBtn.style.marginLeft = "8px";
      removeBtn.style.cursor = "pointer";
      removeBtn.style.borderRadius = "4px";
      removeBtn.title = "–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ";

      removeBtn.addEventListener("click", async (e) => {
        e.stopPropagation();

        // üìå –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –ø–æ–¥–ø–∞–ø–æ–∫
        await window.pywebview.api.remove_favorite_by_filename(fav.filepath.replace(/^.*cache[\\/]/, ""));
		console.log("üßπ –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª:", fav.filename);
        loadFavorites(); // –æ–±–Ω–æ–≤–∏–º
      });

      // Hover-—ç—Ñ—Ñ–µ–∫—Ç—ã
      div.addEventListener("mouseenter", () => {
        isHovered = true;
        if (!isOverRemoveBtn) {
          div.style.boxShadow = "0 0 4px 2px rgba(255, 165, 0, 0.5)";
          div.style.backgroundColor = "#2a2a2a";
        }
      });

      div.addEventListener("mouseleave", () => {
        isHovered = false;
        div.style.boxShadow = "none";
        div.style.backgroundColor = "transparent";
      });

      removeBtn.addEventListener("mouseenter", () => {
        isOverRemoveBtn = true;
        div.style.boxShadow = "0 0 5px 2px rgba(255, 0, 0, 0.5)";
        div.style.backgroundColor = "#331111";
      });

      removeBtn.addEventListener("mouseleave", () => {
        isOverRemoveBtn = false;
        if (isHovered) {
          div.style.boxShadow = "0 0 4px 2px rgba(255, 165, 0, 0.5)";
          div.style.backgroundColor = "#2a2a2a";
        } else {
          div.style.boxShadow = "none";
          div.style.backgroundColor = "transparent";
        }
      });

      div.appendChild(titleSpan);
      div.appendChild(removeBtn);
      container.appendChild(div);
    });
  }
}










document.addEventListener("DOMContentLoaded", async () => {
  console.log('[JS] DOM –≥–æ—Ç–æ–≤');

  // –û–∂–∏–¥–∞–µ–º pywebview, –µ—Å–ª–∏ –Ω–∞–¥–æ
  while (!window.pywebview?.api?.get_playlists) {
    console.log("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ pywebview.api...");
    await new Promise(res => setTimeout(res, 100));
  }

  console.log("üöÄ pywebview API –Ω–∞–π–¥–µ–Ω");

  await loadPlaylists();
  await loadFavorites();
});



function fillPlaylistsSelect(playlists) {
  const select = document.getElementById("playlistSelect");
  select.innerHTML = '<option value="">–í—Å–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã</option>';
  playlists.forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  });

  select.onchange = () => {
    currentPlaylist = select.value || null;
    loadFavorites();
  };
}

function updateFavoritesList(favorites) {
  renderFavoritesList(favorites);
}




window.v_list_text = '–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ - –ó–∞–∫–∞–∂–∏ –ö–ª–∏–ø –∑–∞ –±–∞–ª–ª—ã';
function setVListUrl(val) {
  window.v_list_text = val && val.trim() ? val : window.v_list_text;
  const input = document.getElementById("vlist");
  if (input) input.value = window.v_list_text;
}


function updateQueue(queue) {
  const container = document.getElementById('queueList');
  if (!container) return;

  // –û—á–∏—Å—Ç–∏–º –æ—á–µ—Ä–µ–¥—å –í–ù–ï –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
  container.innerHTML = '';

  if (queue.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;
    td.style.textAlign = 'center';
    td.style.color = '#aaa';
    td.style.fontSize = '26px';
    td.style.fontWeight = 'bold';

    // üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é
    td.textContent = window.v_list_text || '–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ - –ó–∞–∫–∞–∂–∏ –ö–ª–∏–ø –∑–∞ –±–∞–ª–ª—ã';

    tr.appendChild(td);
    container.appendChild(tr);
    return;
  }

  queue.forEach((item, idx) => {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 4;

    const isPlaying = idx === 0 ? 'playing' : '';
	
	let thumbSrc = item.thumbnail;
	if (thumbSrc && /^[a-zA-Z]:\\/.test(thumbSrc)) {
	  thumbSrc = 'file:///' + thumbSrc.replace(/\\/g, '/');
	}
	
	function cleanTitle(title) {
	  return title.replace(/\s*\[[a-zA-Z0-9-_]{11}\].*$/, '').trim();
	}

    td.innerHTML = `
      <div class="queue-item ${isPlaying}" style="display: flex; align-items: center; gap: 11px; border-radius: 8px; padding: 2px;">
        <img src="${thumbSrc}" alt="Thumbnail" style="height: 60px; object-fit: contain; border-radius: 6px; width: 107px;" />
        <div style="display: flex; flex-direction: column;">
          <div style="color: #f5f5f5; font-weight: bold;">${truncate(cleanTitle(item.title), 48)}</div>
          <div style="color: #969696; font-size: 13px;">${formatDuration(item.duration) === '0:00' ? 'playlist' : formatDuration(item.duration)}</div>
          <div style="color: #e0c146; font-size: 13px; font-weight: 700;">${truncate(item.customer, 42)}</div>
        </div>
      </div>
    `;

    tr.appendChild(td);
    container.appendChild(tr);
  });

  updateNowPlaying(queue[0]);
}




function updateNowPlaying(item) {
  const now = document.getElementById('nowPlaying');
  const cust = document.getElementById('nowCustomer');
  if (item && now && cust) {
    now.textContent = item.title;
    cust.textContent = item.customer;
  }
}

function truncate(text) {
  const maxLength = 62;
  return text.length <= maxLength ? text : text.slice(0, maxLength - 3) + '...';
}

// === –¢—Ä–µ–∫–µ—Ä ===
let isTracking = false;
async function toggleTracking() {
  isTracking = await pywebview.api.toggle_tracking();
  const btn = document.getElementById('trackingBtn');
  btn.innerHTML = isTracking ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å';
}




// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—É–∑—ã –≤–∏–¥–µ–æ
function pauseVideo() {
    console.log("–í–∏–¥–µ–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    if (window.pywebview) {
        pywebview.api.pause_video();  // –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –ø–∞—É–∑—ã –∏–∑ Python
    }
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–µ–æ
function stopVideo() {
    console.log("–í–∏–¥–µ–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    if (window.pywebview) {
        pywebview.api.stop_video();  // –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑ Python
    }
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ
function skipVideo() {
    console.log("–í–∏–¥–µ–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ");
    if (window.pywebview) {
        pywebview.api.skip_video();  // –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞ –∏–∑ Python
    }
}
function resumeVideo() {
    console.log("–í–∏–¥–µ–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–æ");
    if (window.pywebview) {
        pywebview.api.resume_video();
    }
}



function onVkChannelInput(value) {
  if (window.pywebview) {
    window.pywebview.api.set_vk_channel_url(value);
  }
}
function setVkChannelUrl(value) {
  const input = document.getElementById('vkChannel');
  if (input) {
    input.value = value;
  }
}
function onTwitchChannelInput(value) {
  if (window.pywebview) {
    window.pywebview.api.set_twitch_channel_url(value);
  }
}
function setTwitchChannelUrl(value) {
  const input = document.getElementById('twitchChannel');
  if (input) {
    input.value = value;
  }
}

function onVListInput(value) {
  if (window.pywebview) {
    window.pywebview.api.set_v_list_url(value);
  }
}

//–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–≤–µ—Ä–ª–µ–π
  function startOverlay() {
    window.pywebview.api.launch_overlay().then(response => {
      console.log(response);
      alert(response);
    });
  }
  
  
  
  
  let currentPlaylist = null;
  const btnAddPlaylist = document.getElementById('btnAddPlaylist');
  const btnEditPlaylist = document.getElementById('btnEditPlaylist');

  const modalAdd = document.getElementById('modalAdd');
  const inputAddName = document.getElementById('inputAddName');
  const cancelAdd = document.getElementById('cancelAdd');
  const confirmAdd = document.getElementById('confirmAdd');

  const modalEdit = document.getElementById('modalEdit');
  const inputEditName = document.getElementById('inputEditName');
  const cancelEdit = document.getElementById('cancelEdit');
  const confirmEdit = document.getElementById('confirmEdit');
  const btnDeleteInModal = document.getElementById('btnDeletePlaylist');



  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –∏–∑ Python
  async function loadPlaylists() {
    try {
      const playlists = await window.pywebview.api.get_playlists();
      playlistSelect.innerHTML = '<option value="">–í—Å–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã</option>';
      playlists.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        playlistSelect.appendChild(option);
      });
      btnEditPlaylist.disabled = !currentPlaylist;
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤');
      console.error(e);
    }
  }

// –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞
playlistSelect.onchange = async () => {
  console.log('playlistSelect onchange triggered, value =', playlistSelect.value);
  currentPlaylist = playlistSelect.value || null;
  btnEditPlaylist.disabled = !currentPlaylist;

  await loadFavorites();

  if (currentPlaylist) {
    await loadPlaylistItems(currentPlaylist);
  } else {
    document.getElementById('playlistItems').innerHTML = '';
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞, –µ—Å–ª–∏ –ø–ª–µ–π–ª–∏—Å—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω
    modalEdit.classList.remove('active');
  }
};

  // –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–∞
  btnAddPlaylist.onclick = () => {
    inputAddName.value = '';
    modalAdd.classList.add('active');
    inputAddName.focus();
  };

  cancelAdd.onclick = () => {
    modalAdd.classList.remove('active');
  };


	confirmAdd.onclick = async () => {
	  const name = inputAddName.value.trim();
	  if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–ª–µ–π–ª–∏—Å—Ç–∞');

	  const res = await window.pywebview.api.create_playlist(name);
	  if (res.success) {
		await loadPlaylists();
		modalAdd.classList.remove('active');
		playlistSelect.value = name;
		currentPlaylist = name;
		btnEditPlaylist.disabled = !currentPlaylist;

		// –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞
		await playlistSelect.onchange();

		await loadFavorites();
	  } else {
		alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${res.error}`);
	  }
	};


  // –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–∞
  btnEditPlaylist.onclick = () => {
    if (!currentPlaylist) return;
    inputEditName.value = currentPlaylist;
    modalEdit.classList.add('active');
    inputEditName.focus();
  };

  cancelEdit.onclick = () => {
    modalEdit.classList.remove('active');
  };

  confirmEdit.onclick = async () => {
    const newName = inputEditName.value.trim();
    if (!newName) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è');
    if (!currentPlaylist) return;
    const res = await window.pywebview.api.rename_playlist(currentPlaylist, newName);
    if (res.success) {
      await loadPlaylists();
      playlistSelect.value = newName;
      currentPlaylist = newName;
      modalEdit.classList.remove('active');
      await loadFavorites();
    } else {
      alert(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: ${res.error}`);
    }
  };

// –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async function updateUIOnPlaylistChange() {
  currentPlaylist = playlistSelect.value || null;
  btnEditPlaylist.disabled = !currentPlaylist;

  await loadFavorites();

  if (currentPlaylist) {
    await loadPlaylistItems(currentPlaylist);
  } else {
    document.getElementById('playlistItems').innerHTML = '';
    modalEdit.classList.remove('active'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä, –µ—Å–ª–∏ –Ω–µ—Ç –ø–ª–µ–π–ª–∏—Å—Ç–∞
  }
}

btnDeleteInModal.onclick = async () => {
  if (!currentPlaylist) return;
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç "${currentPlaylist}"?`)) return;

  const res = await window.pywebview.api.delete_playlist(currentPlaylist);
  if (res.success) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
    await loadPlaylists();

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –Ω–∞ "–í—Å–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã"
    playlistSelect.value = '';

    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
    modalEdit.classList.remove('active');

    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    await updateUIOnPlaylistChange();

  } else {
    alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${res.error}`);
  }
};





  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ currentPlaylist –≤–Ω—É—Ç—Ä–∏ Python)
  async function loadFavorites() {
    const favorites = await window.pywebview.api.get_favorites_from_cache_favs();
    renderFavoritesList(favorites);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', async () => {
    while (!window.pywebview?.api?.get_playlists) {
      await new Promise(r => setTimeout(r, 100));
    }
    await loadPlaylists();
    await loadFavorites();
  });
  
  
  
 




